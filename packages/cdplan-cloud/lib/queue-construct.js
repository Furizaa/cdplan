"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueueConstruct = void 0;
const cdk = require("@aws-cdk/core");
const sfn = require("@aws-cdk/aws-stepfunctions");
const sfnTasks = require("@aws-cdk/aws-stepfunctions-tasks");
const lambda = require("@aws-cdk/aws-lambda");
const dynamodb = require("@aws-cdk/aws-dynamodb");
class QueueConstruct extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const queueTable = new dynamodb.Table(this, "Queue", {
            partitionKey: { name: "token", type: dynamodb.AttributeType.STRING },
        });
        const resultTable = new dynamodb.Table(this, "QueueResult", {
            partitionKey: { name: "token", type: dynamodb.AttributeType.STRING },
        });
        const queueWorker = new lambda.Function(this, "QueueWorker", {
            runtime: lambda.Runtime.NODEJS_12_X,
            handler: "queue-worker.handler",
            code: lambda.Code.fromAsset("src"),
            environment: {
                QUEUE_TABLE_NAME: queueTable.tableName,
                RESULT_TABLE_NAME: resultTable.tableName,
                FUNCTION_NAME_CHARACTER: props.characterWorkerFunc.functionName,
                FUNCTION_NAME_GUILD: props.guildWorkerFunc.functionName,
                FUNCTION_NAME_SPELL: props.spellWorkerFunc.functionName,
                FUNCTION_NAME_ITEM: props.itemWorkerFunc.functionName,
            },
            timeout: cdk.Duration.seconds(15),
        });
        const waitState = new sfn.Wait(this, "Wait X Seconds", {
            time: sfn.WaitTime.secondsPath("$.wait_time"),
        });
        const workerState = new sfnTasks.LambdaInvoke(this, "Work Queue", {
            lambdaFunction: queueWorker,
            outputPath: "$.Payload",
        });
        const chain = sfn.Chain.start(waitState).next(workerState);
        const machine = new sfn.StateMachine(this, "StateMachine", {
            definition: chain,
            timeout: cdk.Duration.seconds(160),
        });
        this.queueInsert = new lambda.Function(this, "QueueInsert", {
            runtime: lambda.Runtime.NODEJS_12_X,
            handler: "queue-insert.handler",
            code: lambda.Code.fromAsset("src"),
            environment: {
                SPELL_CACHE_TABLE_NAME: props.spellCacheTable.tableName,
                ITEM_CACHE_TABLE_NAME: props.itemCacheTable.tableName,
                QUEUE_TABLE_NAME: queueTable.tableName,
                QUEUE_STATE_MACHINE: machine.stateMachineArn,
            },
            timeout: cdk.Duration.seconds(10),
        });
        this.queueLookup = new lambda.Function(this, "QueueLookup", {
            runtime: lambda.Runtime.NODEJS_12_X,
            handler: "queue-lookup.handler",
            code: lambda.Code.fromAsset("src"),
            environment: {
                RESULT_TABLE_NAME: resultTable.tableName,
            },
            timeout: cdk.Duration.seconds(10),
        });
        queueTable.grantReadWriteData(this.queueInsert);
        queueTable.grantReadWriteData(queueWorker);
        resultTable.grantReadData(this.queueLookup);
        resultTable.grantReadWriteData(queueWorker);
        machine.grantStartExecution(this.queueInsert);
        props.characterWorkerFunc.grantInvoke(queueWorker);
        props.guildWorkerFunc.grantInvoke(queueWorker);
        props.spellWorkerFunc.grantInvoke(queueWorker);
        props.itemWorkerFunc.grantInvoke(queueWorker);
        props.itemCacheTable.grantReadData(this.queueInsert);
        props.spellCacheTable.grantReadData(this.queueInsert);
    }
}
exports.QueueConstruct = QueueConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUtY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicXVldWUtY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUFxQztBQUNyQyxrREFBa0Q7QUFDbEQsNkRBQTZEO0FBQzdELDhDQUE4QztBQUM5QyxrREFBa0Q7QUFZbEQsTUFBYSxjQUFlLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFLL0MsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFZO1FBQ3hELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxVQUFVLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUU7WUFDbkQsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7U0FDckUsQ0FBQyxDQUFDO1FBRUgsTUFBTSxXQUFXLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUU7WUFDMUQsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7U0FDckUsQ0FBQyxDQUFDO1FBRUgsTUFBTSxXQUFXLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUU7WUFDM0QsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxPQUFPLEVBQUUsc0JBQXNCO1lBQy9CLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7WUFDbEMsV0FBVyxFQUFFO2dCQUNYLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxTQUFTO2dCQUN0QyxpQkFBaUIsRUFBRSxXQUFXLENBQUMsU0FBUztnQkFDeEMsdUJBQXVC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QztRQUNuRCxLQUFLLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMvQyxLQUFLLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMvQyxLQUFLLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUU5QyxLQUFLLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDckQsS0FBSyxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3hELENBQUM7Q0FDRjtBQXRGRCx3Q0FzRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIHNmbiBmcm9tIFwiQGF3cy1jZGsvYXdzLXN0ZXBmdW5jdGlvbnNcIjtcbmltcG9ydCAqIGFzIHNmblRhc2tzIGZyb20gXCJAYXdzLWNkay9hd3Mtc3RlcGZ1bmN0aW9ucy10YXNrc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tIFwiQGF3cy1jZGsvYXdzLWR5bmFtb2RiXCI7XG5pbXBvcnQgeyBGdW5jdGlvbiB9IGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5cbmludGVyZmFjZSBQcm9wcyB7XG4gIGNoYXJhY3RlcldvcmtlckZ1bmM6IEZ1bmN0aW9uO1xuICBndWlsZFdvcmtlckZ1bmM6IEZ1bmN0aW9uO1xuICBzcGVsbFdvcmtlckZ1bmM6IEZ1bmN0aW9uO1xuICBpdGVtV29ya2VyRnVuYzogRnVuY3Rpb247XG4gIHNwZWxsQ2FjaGVUYWJsZTogZHluYW1vZGIuVGFibGU7XG4gIGl0ZW1DYWNoZVRhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbn1cblxuZXhwb3J0IGNsYXNzIFF1ZXVlQ29uc3RydWN0IGV4dGVuZHMgY2RrLkNvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBxdWV1ZUluc2VydDogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIHB1YmxpYyByZWFkb25seSBxdWV1ZUxvb2t1cDogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgcXVldWVUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlF1ZXVlXCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInRva2VuXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHRUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlF1ZXVlUmVzdWx0XCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInRva2VuXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBxdWV1ZVdvcmtlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJRdWV1ZVdvcmtlclwiLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIGhhbmRsZXI6IFwicXVldWUtd29ya2VyLmhhbmRsZXJcIixcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcInNyY1wiKSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFFVRVVFX1RBQkxFX05BTUU6IHF1ZXVlVGFibGUudGFibGVOYW1lLFxuICAgICAgICBSRVNVTFRfVEFCTEVfTkFNRTogcmVzdWx0VGFibGUudGFibGVOYW1lLFxuICAgICAgICBGVU5DVElPTl9OQU1FX0NIQVJBQ1RFUjogcHJvcHMuY2hhcmFjdGVyV29ya2VyRnVuYy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIEZVTkNUSU9OX05BTUVfR1VJTEQ6IHByb3BzLmd1aWxkV29ya2VyRnVuYy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIEZVTkNUSU9OX05BTUVfU1BFTEw6IHByb3BzLnNwZWxsV29ya2VyRnVuYy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIEZVTkNUSU9OX05BTUVfSVRFTTogcHJvcHMuaXRlbVdvcmtlckZ1bmMuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDE1KSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHdhaXRTdGF0ZSA9IG5ldyBzZm4uV2FpdCh0aGlzLCBcIldhaXQgWCBTZWNvbmRzXCIsIHtcbiAgICAgIHRpbWU6IHNmbi5XYWl0VGltZS5zZWNvbmRzUGF0aChcIiQud2FpdF90aW1lXCIpLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgd29ya2VyU3RhdGUgPSBuZXcgc2ZuVGFza3MuTGFtYmRhSW52b2tlKHRoaXMsIFwiV29yayBRdWV1ZVwiLCB7XG4gICAgICBsYW1iZGFGdW5jdGlvbjogcXVldWVXb3JrZXIsXG4gICAgICBvdXRwdXRQYXRoOiBcIiQuUGF5bG9hZFwiLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2hhaW4gPSBzZm4uQ2hhaW4uc3RhcnQod2FpdFN0YXRlKS5uZXh0KHdvcmtlclN0YXRlKTtcblxuICAgIGNvbnN0IG1hY2hpbmUgPSBuZXcgc2ZuLlN0YXRlTWFjaGluZSh0aGlzLCBcIlN0YXRlTWFjaGluZVwiLCB7XG4gICAgICBkZWZpbml0aW9uOiBjaGFpbixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDE2MCksXG4gICAgfSk7XG5cbiAgICB0aGlzLnF1ZXVlSW5zZXJ0ID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlF1ZXVlSW5zZXJ0XCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgaGFuZGxlcjogXCJxdWV1ZS1pbnNlcnQuaGFuZGxlclwiLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFwic3JjXCIpLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgU1BFTExfQ0FDSEVfVEFCTEVfTkFNRTogcHJvcHMuc3BlbGxDYWNoZVRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgSVRFTV9DQUNIRV9UQUJMRV9OQU1FOiBwcm9wcy5pdGVtQ2FjaGVUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFFVRVVFX1RBQkxFX05BTUU6IHF1ZXVlVGFibGUudGFibGVOYW1lLFxuICAgICAgICBRVUVVRV9TVEFURV9NQUNISU5FOiBtYWNoaW5lLnN0YXRlTWFjaGluZUFybixcbiAgICAgIH0sXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygxMCksXG4gICAgfSk7XG5cbiAgICB0aGlzLnF1ZXVlTG9va3VwID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlF1ZXVlTG9va3VwXCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgaGFuZGxlcjogXCJxdWV1ZS1sb29rdXAuaGFuZGxlclwiLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFwic3JjXCIpLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUkVTVUxUX1RBQkxFX05BTUU6IHJlc3VsdFRhYmxlLnRhYmxlTmFtZSxcbiAgICAgIH0sXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygxMCksXG4gICAgfSk7XG5cbiAgICBxdWV1ZVRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YSh0aGlzLnF1ZXVlSW5zZXJ0KTtcbiAgICBxdWV1ZVRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShxdWV1ZVdvcmtlcik7XG5cbiAgICByZXN1bHRUYWJsZS5ncmFudFJlYWREYXRhKHRoaXMucXVldWVMb29rdXApO1xuICAgIHJlc3VsdFRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShxdWV1ZVdvcmtlcik7XG5cbiAgICBtYWNoaW5lLmdyYW50U3RhcnRFeGVjdXRpb24odGhpcy5xdWV1ZUluc2VydCk7XG5cbiAgICBwcm9wcy5jaGFyYWN0ZXJXb3JrZXJGdW5jLmdyYW50SW52b2tlKHF1ZXVlV29ya2VyKTtcbiAgICBwcm9wcy5ndWlsZFdvcmtlckZ1bmMuZ3JhbnRJbnZva2UocXVldWVXb3JrZXIpO1xuICAgIHByb3BzLnNwZWxsV29ya2VyRnVuYy5ncmFudEludm9rZShxdWV1ZVdvcmtlcik7XG4gICAgcHJvcHMuaXRlbVdvcmtlckZ1bmMuZ3JhbnRJbnZva2UocXVldWVXb3JrZXIpO1xuXG4gICAgcHJvcHMuaXRlbUNhY2hlVGFibGUuZ3JhbnRSZWFkRGF0YSh0aGlzLnF1ZXVlSW5zZXJ0KTtcbiAgICBwcm9wcy5zcGVsbENhY2hlVGFibGUuZ3JhbnRSZWFkRGF0YSh0aGlzLnF1ZXVlSW5zZXJ0KTtcbiAgfVxufVxuIl19